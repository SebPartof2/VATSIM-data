<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>VATSIM Controllers — Primary Positions</title>
    <style>
      :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:0}
      body{background:#0b1220;color:#e6eef8;min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:24px}
      .card{background:#0f1724;border:1px solid rgba(255,255,255,0.04);border-radius:10px;padding:18px;max-width:880px;width:100%;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
      h1{margin:0 0 12px;font-size:20px}
      p.lead{margin:0 0 16px;color:#9fb0d6}
      .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
      button{background:#1f6feb;color:white;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
      button[disabled]{opacity:0.6;cursor:default}
      .muted{color:#99a8c6;font-size:13px}
  ul.list{list-style:none;padding:0;margin:0;display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:8px}
  li.item{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;gap:8px}
  .left{flex:1;display:flex;flex-direction:column;gap:6px}
  .left .radio{font-size:16px;font-weight:700;color:#fff}
  .left .facility{font-size:13px;color:#aec6e8}
  .left .realname{font-size:12px;color:#9fb0d6}
  .right{width:140px;flex:0 0 140px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px}
  .freq{font-size:18px;font-weight:700;color:#9fc3ff}
  .callsign-small{font-size:12px;color:#9fb0d6}
      .error{color:#ffb4b4;background:#3b0f0f;padding:10px;border-radius:8px}
      .loading{color:#cde3ff}
      footer{margin-top:12px;font-size:12px;color:#86a0cc}
      @media (max-width:420px){.card{padding:12px}}
    </style>
  </head>
  <body>
    <main class="card" role="main">
      <h1>VATSIM Controllers — Primary Positions</h1>
      <p class="lead">Showing only primary positions from the live controllers feed.</p>

      <div class="controls">
        <button id="refresh">Refresh</button>
        <div id="status" class="muted">Updated: —</div>
      </div>

      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <label for="artccFilter" class="muted">Filter ARTCC:</label>
        <select id="artccFilter">
          <option value="ALL">All ARTCCs</option>
        </select>
        <div id="artccTitle" style="margin-left:auto;font-weight:700;color:#cfe4ff"></div>
      </div>

      <div id="artccTiles" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px"></div>

      <div id="message" aria-live="polite"></div>
      <ul id="list" class="list" aria-live="polite"></ul>

      <footer>Data source: <a href="https://live.env.vnas.vatsim.net/data-feed/controllers.json" target="_blank" rel="noreferrer noopener" style="color:#9fc3ff">controllers.json</a></footer>
    </main>

    <script>
  const UPSTREAM_URL = 'https://live.env.vnas.vatsim.net/data-feed/controllers.json';
  const PROXY_URL = '/proxy/controllers.json'; // local proxy provided by server.js (optional)
      const refreshBtn = document.getElementById('refresh');
      const statusEl = document.getElementById('status');
      const listEl = document.getElementById('list');
      const msgEl = document.getElementById('message');

      function showMessage(text, className){
        msgEl.innerHTML = '';
        if(!text) return;
        const div = document.createElement('div');
        div.textContent = text;
        if(className) div.className = className;
        msgEl.appendChild(div);
      }

      async function load(){
        refreshBtn.disabled = true;
        showMessage('Loading…', 'loading');
        listEl.innerHTML = '';
        try{
          // Try local proxy first (if server.js is running). If it fails, fall back to upstream.
          let res = null;
          try{
            res = await fetch(PROXY_URL, {cache: 'no-store'});
          }catch(e){
            // probe failed — will try upstream
            res = null;
          }

          if(!res || !res.ok){
            // fallback to upstream
            res = await fetch(UPSTREAM_URL, {cache: 'no-store'});
          }

          if(!res.ok) throw new Error(`Network error: ${res.status} ${res.statusText}`);
          const data = await res.json();

          const updated = data.updatedAt || null;
          statusEl.textContent = updated ? `Updated: ${new Date(updated).toLocaleString()}` : 'Updated: —';

          const controllers = Array.isArray(data.controllers) ? data.controllers : [];

          // Build list of primary positions
          window.__VATSIM_items = [];
          window.__VATSIM_artccs = {}; // map artccId -> {code, displayName}
          for(const c of controllers){
            const positions = Array.isArray(c.positions) ? c.positions : [];
            // primary may be flagged by isPrimary or by matching primaryPositionId
            const primary = positions.find(p=>p.isPrimary) || positions.find(p=>p.positionId === c.primaryPositionId);
            if(!primary) continue;

            const callsign = (c.vatsimData && c.vatsimData.callsign) || primary.defaultCallsign || '';
            const positionName = primary.positionName || primary.radioName || '';
            const facilityName = primary.facilityName || c.primaryFacilityId || '';
            const radioName = primary.radioName || '';
            const frequency = typeof primary.frequency === 'number' ? primary.frequency : (primary.frequency ? Number(primary.frequency) : null);
            const realName = (c.vatsimData && c.vatsimData.realName) || '';
            window.__VATSIM_items.push({callsign, positionName, facilityName, radioName, frequency, realName, artccId: c.artccId});
            // remember artcc display name by first observed facilityName
            if(c.artccId && !window.__VATSIM_artccs[c.artccId]){
              // try to get a friendly name from primary position or facilityName
              window.__VATSIM_artccs[c.artccId] = {
                code: c.artccId,
                displayName: (primary.facilityName || `${c.artccId} ARTCC`)
              };
            }
          }

          if(window.__VATSIM_items.length === 0){
            showMessage('No primary positions found.', 'muted');
          } else {
            showMessage('', '');
            // populate ARTCC filter select
            const artccSelect = document.getElementById('artccFilter');
            // clear existing (keep All)
            Array.from(artccSelect.querySelectorAll('option[value^="ART"]')).forEach(o=>o.remove());
            const artccEntries = Object.values(window.__VATSIM_artccs).sort((a,b)=>a.code.localeCompare(b.code));
            for(const a of artccEntries){
              const opt = document.createElement('option'); opt.value = a.code; opt.textContent = `${a.displayName} - ${a.code}`;
              artccSelect.appendChild(opt);
            }

            // try to load artccs.json (editable config)
            try{
              const cfgRes = await fetch('/artccs.json');
              if(cfgRes.ok){
                const cfg = await cfgRes.json();
                if(Array.isArray(cfg) && cfg.length){
                  // render tiles using config order
                  renderArtccTiles(cfg.map(x=>({code:x.code,name:x.name})));
                } else {
                  renderArtccTiles(artccEntries.map(a=>({code:a.code,name:a.displayName})));
                }
              } else {
                renderArtccTiles(artccEntries.map(a=>({code:a.code,name:a.displayName})));
              }
            }catch(e){
              renderArtccTiles(artccEntries.map(a=>({code:a.code,name:a.displayName})));
            }

            function renderArtccTiles(list){
              const container = document.getElementById('artccTiles');
              container.innerHTML = '';
              for(const a of list){
                const btn = document.createElement('button');
                btn.textContent = `${a.name} - ${a.code}`;
                btn.dataset.code = a.code;
                btn.style.background = 'transparent';
                btn.style.border = '1px solid rgba(255,255,255,0.06)';
                btn.style.color = 'inherit';
                btn.style.padding = '6px 10px';
                btn.style.borderRadius = '8px';
                btn.style.cursor = 'pointer';
                btn.addEventListener('click', ()=>{
                  // set select and dispatch change
                  artccSelect.value = a.code;
                  artccSelect.dispatchEvent(new Event('change'));
                  // visually mark selected
                  Array.from(container.children).forEach(c=>c.style.opacity = '0.6');
                  btn.style.opacity = '1';
                });
                container.appendChild(btn);
              }
            }

            // sort alphabetically by callsign
            window.__VATSIM_items.sort((a,b)=>a.callsign.localeCompare(b.callsign));
            function renderItems(itemsToRender){
              listEl.innerHTML = '';
              for(const it of itemsToRender){
                const li = document.createElement('li');
                li.className = 'item';
                const left = document.createElement('div'); left.className = 'left';
                  const radio = document.createElement('div'); radio.className = 'radio'; radio.textContent = it.radioName || it.positionName || '';
                  const facility = document.createElement('div'); facility.className = 'facility'; facility.textContent = it.facilityName || '';
                  const real = document.createElement('div'); real.className = 'realname'; real.textContent = it.realName || '';
                const right = document.createElement('div'); right.className = 'right';
                const freq = document.createElement('div'); freq.className = 'freq';
                if(it.frequency){
                  const mhz = (it.frequency / 1e6).toFixed(3).replace(/\.([0-9]*?)0+$/,'.$1').replace(/\.$/, '');
                  freq.textContent = `${mhz} MHz`;
                } else {
                  freq.textContent = '';
                }
                left.appendChild(radio);
                if(facility.textContent) left.appendChild(facility);
                if(real.textContent) left.appendChild(real);
                right.appendChild(freq);
                const csSmall = document.createElement('div'); csSmall.className = 'callsign-small'; csSmall.textContent = it.callsign || '';
                if(csSmall.textContent) right.appendChild(csSmall);
                li.appendChild(left);
                li.appendChild(right);
                listEl.appendChild(li);
              }
            }

            // initial render = all items
            renderItems(window.__VATSIM_items);
            // hook filter change
            const artccTitle = document.getElementById('artccTitle');
            document.getElementById('artccFilter').addEventListener('change', (e)=>{
              const val = e.target.value;
              if(val === 'ALL'){
                artccTitle.textContent = '';
                renderItems(window.__VATSIM_items);
                return;
              }
              const matching = window.__VATSIM_items.filter(i=>i.artccId === val);
              const meta = window.__VATSIM_artccs[val] || {code: val, displayName: val};
              artccTitle.textContent = `${meta.displayName} - ${meta.code}`;
              renderItems(matching);
            });
          }

        }catch(err){
          console.error(err);
          // CORS and network errors are common when opening locally — show helpful hint
          const isCors = /(CORS|cross-origin)/i.test(err.message) || err instanceof TypeError;
          showMessage(isCors ? 'Could not fetch data (possible CORS or network issue). Try serving this page via a local HTTP server or use a proxy. See console for details.' : `Error: ${err.message}`, 'error');
        } finally {
          refreshBtn.disabled = false;
        }
      }

      refreshBtn.addEventListener('click', ()=> load());
      // initial load
      load();
    </script>
  </body>
</html>
